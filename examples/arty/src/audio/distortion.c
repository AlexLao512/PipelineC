#include "lib/fixed/q0_23.h"

// AUTO GEN INTERP LUT
//q0_23_t x,y;y = sign(x) * (1 - e^(-abs(x)))
// Linear interpolation
// See interp_lut_gen.py
#define interp_fixed_t uint17_t
#define lut_addr_t uint7_t
q0_23_t distortion_func(q0_23_t x)
{
  // Get lookup addr from top bits of value
  lut_addr_t lut_addr = int24_23_17(x.qmn);
  // And interpolation bits from lsbs 
  interp_fixed_t interp_point = int24_16_0(x.qmn);
  
  // Generated lookup tables
  q0_23_t Y_VALUES[128];
  Y_VALUES[64].qmn = -0x50e953;
  Y_VALUES[65].qmn = -0x502b7e;
  Y_VALUES[66].qmn = -0x4f6aab;
  Y_VALUES[67].qmn = -0x4ea6cf;
  Y_VALUES[68].qmn = -0x4ddfdd;
  Y_VALUES[69].qmn = -0x4d15ca;
  Y_VALUES[70].qmn = -0x4c4887;
  Y_VALUES[71].qmn = -0x4b780a;
  Y_VALUES[72].qmn = -0x4aa443;
  Y_VALUES[73].qmn = -0x49cd27;
  Y_VALUES[74].qmn = -0x48f2a8;
  Y_VALUES[75].qmn = -0x4814b8;
  Y_VALUES[76].qmn = -0x473349;
  Y_VALUES[77].qmn = -0x464e4e;
  Y_VALUES[78].qmn = -0x4565b7;
  Y_VALUES[79].qmn = -0x447976;
  Y_VALUES[80].qmn = -0x43897e;
  Y_VALUES[81].qmn = -0x4295bd;
  Y_VALUES[82].qmn = -0x419e26;
  Y_VALUES[83].qmn = -0x40a2a9;
  Y_VALUES[84].qmn = -0x3fa337;
  Y_VALUES[85].qmn = -0x3e9fbe;
  Y_VALUES[86].qmn = -0x3d982f;
  Y_VALUES[87].qmn = -0x3c8c7a;
  Y_VALUES[88].qmn = -0x3b7c8d;
  Y_VALUES[89].qmn = -0x3a6858;
  Y_VALUES[90].qmn = -0x394fca;
  Y_VALUES[91].qmn = -0x3832d1;
  Y_VALUES[92].qmn = -0x37115b;
  Y_VALUES[93].qmn = -0x35eb56;
  Y_VALUES[94].qmn = -0x34c0af;
  Y_VALUES[95].qmn = -0x339155;
  Y_VALUES[96].qmn = -0x325d34;
  Y_VALUES[97].qmn = -0x312438;
  Y_VALUES[98].qmn = -0x2fe64f;
  Y_VALUES[99].qmn = -0x2ea364;
  Y_VALUES[100].qmn = -0x2d5b63;
  Y_VALUES[101].qmn = -0x2c0e38;
  Y_VALUES[102].qmn = -0x2abbce;
  Y_VALUES[103].qmn = -0x29640f;
  Y_VALUES[104].qmn = -0x2806e7;
  Y_VALUES[105].qmn = -0x26a43f;
  Y_VALUES[106].qmn = -0x253c02;
  Y_VALUES[107].qmn = -0x23ce18;
  Y_VALUES[108].qmn = -0x225a6b;
  Y_VALUES[109].qmn = -0x20e0e3;
  Y_VALUES[110].qmn = -0x1f616a;
  Y_VALUES[111].qmn = -0x1ddbe7;
  Y_VALUES[112].qmn = -0x1c5041;
  Y_VALUES[113].qmn = -0x1abe60;
  Y_VALUES[114].qmn = -0x19262c;
  Y_VALUES[115].qmn = -0x178789;
  Y_VALUES[116].qmn = -0x15e25f;
  Y_VALUES[117].qmn = -0x143693;
  Y_VALUES[118].qmn = -0x12840b;
  Y_VALUES[119].qmn = -0x10caab;
  Y_VALUES[120].qmn = -0xf0a57;
  Y_VALUES[121].qmn = -0xd42f4;
  Y_VALUES[122].qmn = -0xb7465;
  Y_VALUES[123].qmn = -0x99e8d;
  Y_VALUES[124].qmn = -0x7c150;
  Y_VALUES[125].qmn = -0x5dc8e;
  Y_VALUES[126].qmn = -0x3f02a;
  Y_VALUES[127].qmn = -0x1fc05;
  Y_VALUES[0].qmn = 0x0;
  Y_VALUES[1].qmn = 0x1fc05;
  Y_VALUES[2].qmn = 0x3f02a;
  Y_VALUES[3].qmn = 0x5dc8e;
  Y_VALUES[4].qmn = 0x7c150;
  Y_VALUES[5].qmn = 0x99e8d;
  Y_VALUES[6].qmn = 0xb7465;
  Y_VALUES[7].qmn = 0xd42f4;
  Y_VALUES[8].qmn = 0xf0a57;
  Y_VALUES[9].qmn = 0x10caab;
  Y_VALUES[10].qmn = 0x12840b;
  Y_VALUES[11].qmn = 0x143693;
  Y_VALUES[12].qmn = 0x15e25f;
  Y_VALUES[13].qmn = 0x178789;
  Y_VALUES[14].qmn = 0x19262c;
  Y_VALUES[15].qmn = 0x1abe60;
  Y_VALUES[16].qmn = 0x1c5041;
  Y_VALUES[17].qmn = 0x1ddbe7;
  Y_VALUES[18].qmn = 0x1f616a;
  Y_VALUES[19].qmn = 0x20e0e3;
  Y_VALUES[20].qmn = 0x225a6b;
  Y_VALUES[21].qmn = 0x23ce18;
  Y_VALUES[22].qmn = 0x253c02;
  Y_VALUES[23].qmn = 0x26a43f;
  Y_VALUES[24].qmn = 0x2806e7;
  Y_VALUES[25].qmn = 0x29640f;
  Y_VALUES[26].qmn = 0x2abbce;
  Y_VALUES[27].qmn = 0x2c0e38;
  Y_VALUES[28].qmn = 0x2d5b63;
  Y_VALUES[29].qmn = 0x2ea364;
  Y_VALUES[30].qmn = 0x2fe64f;
  Y_VALUES[31].qmn = 0x312438;
  Y_VALUES[32].qmn = 0x325d34;
  Y_VALUES[33].qmn = 0x339155;
  Y_VALUES[34].qmn = 0x34c0af;
  Y_VALUES[35].qmn = 0x35eb56;
  Y_VALUES[36].qmn = 0x37115b;
  Y_VALUES[37].qmn = 0x3832d1;
  Y_VALUES[38].qmn = 0x394fca;
  Y_VALUES[39].qmn = 0x3a6858;
  Y_VALUES[40].qmn = 0x3b7c8d;
  Y_VALUES[41].qmn = 0x3c8c7a;
  Y_VALUES[42].qmn = 0x3d982f;
  Y_VALUES[43].qmn = 0x3e9fbe;
  Y_VALUES[44].qmn = 0x3fa337;
  Y_VALUES[45].qmn = 0x40a2a9;
  Y_VALUES[46].qmn = 0x419e26;
  Y_VALUES[47].qmn = 0x4295bd;
  Y_VALUES[48].qmn = 0x43897e;
  Y_VALUES[49].qmn = 0x447976;
  Y_VALUES[50].qmn = 0x4565b7;
  Y_VALUES[51].qmn = 0x464e4e;
  Y_VALUES[52].qmn = 0x473349;
  Y_VALUES[53].qmn = 0x4814b8;
  Y_VALUES[54].qmn = 0x48f2a8;
  Y_VALUES[55].qmn = 0x49cd27;
  Y_VALUES[56].qmn = 0x4aa443;
  Y_VALUES[57].qmn = 0x4b780a;
  Y_VALUES[58].qmn = 0x4c4887;
  Y_VALUES[59].qmn = 0x4d15ca;
  Y_VALUES[60].qmn = 0x4ddfdd;
  Y_VALUES[61].qmn = 0x4ea6cf;
  Y_VALUES[62].qmn = 0x4f6aab;
  Y_VALUES[63].qmn = 0x502b7e;
  
  q0_23_t M_VALUES[128];
  M_VALUES[64].qmn = 0x2f7557;
  M_VALUES[65].qmn = 0x3034aa;
  M_VALUES[66].qmn = 0x30f701;
  M_VALUES[67].qmn = 0x31bc66;
  M_VALUES[68].qmn = 0x3284e8;
  M_VALUES[69].qmn = 0x335092;
  M_VALUES[70].qmn = 0x341f71;
  M_VALUES[71].qmn = 0x34f192;
  M_VALUES[72].qmn = 0x35c702;
  M_VALUES[73].qmn = 0x369fce;
  M_VALUES[74].qmn = 0x377c05;
  M_VALUES[75].qmn = 0x385bb3;
  M_VALUES[76].qmn = 0x393ee7;
  M_VALUES[77].qmn = 0x3a25af;
  M_VALUES[78].qmn = 0x3b101a;
  M_VALUES[79].qmn = 0x3bfe35;
  M_VALUES[80].qmn = 0x3cf010;
  M_VALUES[81].qmn = 0x3de5bb;
  M_VALUES[82].qmn = 0x3edf43;
  M_VALUES[83].qmn = 0x3fdcba;
  M_VALUES[84].qmn = 0x40de2e;
  M_VALUES[85].qmn = 0x41e3b1;
  M_VALUES[86].qmn = 0x42ed51;
  M_VALUES[87].qmn = 0x43fb21;
  M_VALUES[88].qmn = 0x450d30;
  M_VALUES[89].qmn = 0x462390;
  M_VALUES[90].qmn = 0x473e52;
  M_VALUES[91].qmn = 0x485d89;
  M_VALUES[92].qmn = 0x498145;
  M_VALUES[93].qmn = 0x4aa999;
  M_VALUES[94].qmn = 0x4bd698;
  M_VALUES[95].qmn = 0x4d0854;
  M_VALUES[96].qmn = 0x4e3ee1;
  M_VALUES[97].qmn = 0x4f7a52;
  M_VALUES[98].qmn = 0x50baba;
  M_VALUES[99].qmn = 0x52002e;
  M_VALUES[100].qmn = 0x534ac2;
  M_VALUES[101].qmn = 0x549a8b;
  M_VALUES[102].qmn = 0x55ef9e;
  M_VALUES[103].qmn = 0x574a0f;
  M_VALUES[104].qmn = 0x58a9f6;
  M_VALUES[105].qmn = 0x5a0f66;
  M_VALUES[106].qmn = 0x5b7a78;
  M_VALUES[107].qmn = 0x5ceb42;
  M_VALUES[108].qmn = 0x5e61da;
  M_VALUES[109].qmn = 0x5fde59;
  M_VALUES[110].qmn = 0x6160d5;
  M_VALUES[111].qmn = 0x62e967;
  M_VALUES[112].qmn = 0x647828;
  M_VALUES[113].qmn = 0x660d31;
  M_VALUES[114].qmn = 0x67a89a;
  M_VALUES[115].qmn = 0x694a7e;
  M_VALUES[116].qmn = 0x6af2f7;
  M_VALUES[117].qmn = 0x6ca21f;
  M_VALUES[118].qmn = 0x6e5811;
  M_VALUES[119].qmn = 0x7014e9;
  M_VALUES[120].qmn = 0x71d8c2;
  M_VALUES[121].qmn = 0x73a3b8;
  M_VALUES[122].qmn = 0x7575e9;
  M_VALUES[123].qmn = 0x774f71;
  M_VALUES[124].qmn = 0x79306f;
  M_VALUES[125].qmn = 0x7b18ff;
  M_VALUES[126].qmn = 0x7d0941;
  M_VALUES[127].qmn = 0x7f0154;
  M_VALUES[0].qmn = 0x7f0154;
  M_VALUES[1].qmn = 0x7d0941;
  M_VALUES[2].qmn = 0x7b18ff;
  M_VALUES[3].qmn = 0x79306f;
  M_VALUES[4].qmn = 0x774f71;
  M_VALUES[5].qmn = 0x7575e9;
  M_VALUES[6].qmn = 0x73a3b8;
  M_VALUES[7].qmn = 0x71d8c2;
  M_VALUES[8].qmn = 0x7014e9;
  M_VALUES[9].qmn = 0x6e5811;
  M_VALUES[10].qmn = 0x6ca21f;
  M_VALUES[11].qmn = 0x6af2f7;
  M_VALUES[12].qmn = 0x694a7e;
  M_VALUES[13].qmn = 0x67a89a;
  M_VALUES[14].qmn = 0x660d31;
  M_VALUES[15].qmn = 0x647828;
  M_VALUES[16].qmn = 0x62e967;
  M_VALUES[17].qmn = 0x6160d5;
  M_VALUES[18].qmn = 0x5fde59;
  M_VALUES[19].qmn = 0x5e61da;
  M_VALUES[20].qmn = 0x5ceb42;
  M_VALUES[21].qmn = 0x5b7a78;
  M_VALUES[22].qmn = 0x5a0f66;
  M_VALUES[23].qmn = 0x58a9f6;
  M_VALUES[24].qmn = 0x574a0f;
  M_VALUES[25].qmn = 0x55ef9e;
  M_VALUES[26].qmn = 0x549a8b;
  M_VALUES[27].qmn = 0x534ac2;
  M_VALUES[28].qmn = 0x52002e;
  M_VALUES[29].qmn = 0x50baba;
  M_VALUES[30].qmn = 0x4f7a52;
  M_VALUES[31].qmn = 0x4e3ee1;
  M_VALUES[32].qmn = 0x4d0854;
  M_VALUES[33].qmn = 0x4bd698;
  M_VALUES[34].qmn = 0x4aa999;
  M_VALUES[35].qmn = 0x498145;
  M_VALUES[36].qmn = 0x485d89;
  M_VALUES[37].qmn = 0x473e52;
  M_VALUES[38].qmn = 0x462390;
  M_VALUES[39].qmn = 0x450d30;
  M_VALUES[40].qmn = 0x43fb21;
  M_VALUES[41].qmn = 0x42ed51;
  M_VALUES[42].qmn = 0x41e3b1;
  M_VALUES[43].qmn = 0x40de2e;
  M_VALUES[44].qmn = 0x3fdcba;
  M_VALUES[45].qmn = 0x3edf43;
  M_VALUES[46].qmn = 0x3de5bb;
  M_VALUES[47].qmn = 0x3cf010;
  M_VALUES[48].qmn = 0x3bfe35;
  M_VALUES[49].qmn = 0x3b101a;
  M_VALUES[50].qmn = 0x3a25af;
  M_VALUES[51].qmn = 0x393ee7;
  M_VALUES[52].qmn = 0x385bb3;
  M_VALUES[53].qmn = 0x377c05;
  M_VALUES[54].qmn = 0x369fce;
  M_VALUES[55].qmn = 0x35c702;
  M_VALUES[56].qmn = 0x34f192;
  M_VALUES[57].qmn = 0x341f71;
  M_VALUES[58].qmn = 0x335092;
  M_VALUES[59].qmn = 0x3284e8;
  M_VALUES[60].qmn = 0x31bc66;
  M_VALUES[61].qmn = 0x30f701;
  M_VALUES[62].qmn = 0x3034aa;
  M_VALUES[63].qmn = 0x2f7557;
  
  // Do lookup
  q0_23_t y = Y_VALUES[lut_addr];
  q0_23_t m = M_VALUES[lut_addr];

  // Do linear interp, dy = dx * m
  interp_fixed_t dxi = interp_point;
  // Multiply, round then scale absolute slope M into X fractional units
  q0_23_t dy;
  dy.qmn = ((dxi * m.qmn) + (1 << (23 - 1))) >> 23;
  /*printf("y_lut %f, dx %X * %f m = %f dy\n", 
         q0_23_to_float(y), dxi, q0_23_to_float(m), q0_23_to_float(dy));*/
  q0_23_t yi = q0_23_add(y, dy);
  return yi;
}
